# Adaptive Filter Module — Test Mode

- **기존 전략의 진입/청산 규칙은 변경하지 않음.**
- 능동성은 **거래 활성 여부**와 **포지션 크기(배율)** 만 조절.

## 1. 시장 상태 (4시간봉 기준 ADX)

| ADX        | 상태   | 포지션 배율 | 진입 |
|-----------|--------|-------------|------|
| ADX < 18  | OFF    | 0           | 금지 |
| 18 ≤ ADX < 25 | WEAK   | 0.5배  | 허용 |
| 25 ≤ ADX < 35 | NORMAL | 1.0배  | 허용 |
| ADX ≥ 35  | STRONG | 1.3배  | 허용 |

## 2. 변동성 필터 (ATR)

- **최근 ATR < ATR(30) × 0.7** → 횡보로 판단 → **신규 진입 금지**
- 청산/스탑은 기존대로 진행.

## 3. 연속 손실 보호

- **최근 3회 연속 손실** → 다음 **2개 신호** 동안 진입 금지 (쿨다운).

## 4. 우선순위

- 기존 진입/청산 규칙이 항상 최우선.
- 필터는 "거래 여부와 규모"만 조절하며, **방향 판단은 하지 않음.**

## 5. 테스트 모드 — 로그

- 모든 거래 로그(백테스트 `trades` 배열)에 **`filter_state`** 기록:
  - `OFF` / `WEAK` / `NORMAL` / `STRONG`
- 진입 시 `position_mult` (0.5, 1.0, 1.3) 기록.
- 청산 시 해당 진입 당시의 `filter_state` 기록.

## 구현 위치

- `app/services/adaptive_filter.py`: 상태·배율·변동성·연속손실 판단.
- `app/backtest.py`: 진입 전 필터 호출, 포지션 배율 적용, 로그에 `filter_state` 기록.
