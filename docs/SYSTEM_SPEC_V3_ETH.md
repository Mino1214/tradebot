# 🏆 자동매매 시스템 구현 프롬프트 (최종 통합 v3 — ETH 단일 보수형)

> **사용법**: 이 문서 전체를 Cursor(또는 다른 AI 에디터)에 붙여넣고,  
> *"아래 스펙대로 전체 시스템 구현 시작해줘"* 라고 요청하면 된다.

**용도**: "전체 시스템 구현 시작" 가능한 최종 통합 스펙.  
**디테일 코드 지시 없음** — 구현 가능한 수준의 시스템 스펙만 제시.

---

너는 **ETH 단일 자동매매 시스템 전체**를 구현하는 시니어 퀀트 개발자다.  
아래 요구사항을 만족하는 **보수형** 자동매매 아키텍처를 설계·구현하라.

---

## 🎯 시스템 목표

- **생존 최우선** (보수형)
- **과매매 금지**
- **ETH 단일 심볼**
- **C-A-B 계층 구조**
- **멀티 타임프레임 기반**
- **가상매매(PAPER) + 실전매매(LIVE) 전환 가능**
- **관리자 페이지로 제어 가능**
- **사고 시 즉시 정지 가능**
- **상태를 사람이 이해하기 쉽게 표시**

---

## 🪙 기본 설정

| 항목 | 값 |
|------|-----|
| Symbol | **ETHUSDT** (단일) |
| Market | 선물 (롱/숏 가능) |
| max_positions | **1** (계정 전체) |
| 전략 충돌 | 금지 |
| 자동 레버리지 변경 | 금지 |

---

## ⏱️ 타임프레임 구조 (보수형)

| TF | 역할 | 용도 |
|----|------|------|
| **1D** | 시장 흐름 (Context) | 방향 필터 |
| **4H** | 전략 실행 (Primary) | Regime·전략 선택·진입/청산 규칙 — **모든 전략 계산 기준** |
| **1H** | 위험 감지 (Safety) | 급등락·변동성 과열 감지, **진입 직전 차단용** (진입 신호 생성에는 사용하지 않음) |

### 역할 상세

- **1D — 방향 필터**  
  장기 추세 판단, 역추세 진입 방지, B봇 과도 사용 방지.

- **4H — 실제 매매 판단**  
  Regime 판정, 전략 선택, 진입/청산 규칙. **모든 전략 계산 기준.**

- **1H — 위험 감지**  
  급등락 필터, 변동성 과열 감지, **진입 직전 차단용**. 진입 신호 생성에는 사용하지 않음.

---

## 🧠 시스템 구조

```
관리자 제어 (최상위)
        ↓
C봇 (중재 / 리스크 / 스위치)
        ↓
A봇 (추세 전략)   B봇 (평균회귀 전략)
        ↓
Execution Engine
        ↓
PAPER 계좌  또는  거래소 API (LIVE)
```

---

## 🧠 C봇 — Meta Bot (핵심)

**역할**

- Regime 판정 (TREND / RANGE / NEUTRAL)
- 전략 선택 (A / B / NONE)
- 신규 진입 허용 여부 결정
- **멀티 TF 종합 판단**
- Risk Gate 수행
- Emergency 처리

### Regime 판정 (4H 기준)

- **TREND**: ADX 높음, EMA slope 큼, 과열 상태 아님
- **RANGE**: ADX 낮음, slope 작음, 과열 아님
- **NEUTRAL**: 위 조건에 해당하지 않음

### Context 보정 (1D)

- 1D가 **강한 추세**인데 4H가 RANGE면 → RANGE 신뢰도 낮춤, **NEUTRAL 가능**

### Safety 필터 (1H)

**진입 직전 검사**

- ATR 과열
- 급등락 캔들
- 변동성 폭증  

→ TRUE면 **신규 진입 차단**

### 전략 선택 규칙

- **TREND** → A봇 활성  
- **RANGE** → B봇 활성  
- **NEUTRAL** → 신규 진입 없음  

---

## 🚨 Risk Gate (공통)

**신규 진입 차단 조건**

| 구분 | 조건 |
|------|------|
| 계좌 기반 | 일일 손실 한도 초과, 연속 손실 제한 초과, 이미 포지션 존재, max_positions 초과 |
| 시장 기반 | 변동성 과열, Safety TF(1H) 위험 |
| 시스템 기반 | cooldown 상태, emergency mode, 관리자 차단, PAUSED 상태 |

---

## 🐢 A봇 — 추세 전략

- **보수형**: Donchian Breakout, ATR 기반 트레일링 스탑, 추가 진입 없음 또는 최소
- **특징**: 큰 추세만 포착, 거래 빈도 낮음, 손익비 우위

---

## 🎯 B봇 — 평균회귀 전략

- **보수형**: Bollinger Bands, RSI, 낮은 ADX 조건 필수, 강한 추세에서는 비활성
- **특징**: 횡보장에서만 동작, 빠른 청산, 손절 필수

---

## ⚡ Execution Engine

### PAPER / LIVE 모드 분리

| 모드 | 동작 |
|------|------|
| **PAPER** | 실제 주문 없음, 가상 포지션 생성, 수수료/슬리피지 시뮬레이션, 실시간 모의 거래 |
| **LIVE** | 거래소 API 주문, 체결 확인, 실제 포지션 동기화 |

- **동일 인터페이스**: A/B/C 봇은 모드를 몰라도 됨 → Execution 레이어에서만 PAPER/LIVE 분기.

---

## 💰 포지션 관리

- **관리자 설정**: leverage, risk_per_trade %, max_positions, position_size_mode  
- **자동 변경 금지**

---

## 🛠️ 관리자 제어 레이어 (최상위)

**C봇보다 우선**

### 필수 버튼

| 버튼 | 동작 |
|------|------|
| **▶️ Run / Pause** | 전체 거래 중지 또는 재개 |
| **🚫 New Entry ON/OFF** | 신규 진입만 차단 (포지션 유지) |
| **💥 Emergency Stop** | 신규 진입 차단, 선택적으로 강제 청산 가능 |
| **❌ Close Position** | 현재 포지션 즉시 종료 |

### 설정

- 레버리지, 리스크 %, 최대 포지션 수, **모드 (PAPER / LIVE)**

### 우선순위

**관리자 제어 > C봇 판단 > A/B 신호**

---

## 📊 상태 관리 & UI 출력용 데이터

관리자 페이지에서 표시할 항목:

| 영역 | 표시 항목 |
|------|------------|
| **시스템** | 실행 상태, 모드(가상/실전), 신규 진입 상태, 레버리지 설정 |
| **C봇** | Regime, Active Strategy, Blocked reason, 핵심 지표, Cooldown |
| **A/B 봇** | 신호 상태, 허용 여부, 차단 이유 |
| **포지션** | owner_bot, 진입 근거, 손익, 보호 장치 |

---

## 🏁 운영 흐름 (캔들 마감 기준)

1. **멀티 TF 데이터 수집** (1D / 4H / 1H)
2. **C봇 Regime 판단**
3. **Context + Safety 필터 적용**
4. **전략 선택** (A / B / NONE)
5. **Risk Gate 평가**
6. **관리자 제어 반영**
7. 허용 시 **활성 봇 신호 평가**
8. **Execution Engine 실행**  
   - PAPER → 가상 주문  
   - LIVE → 실제 주문  
9. **상태 저장 및 UI 업데이트**

---

## 💀 보수형 시스템 특성

- 거래 횟수 낮음  
- 급변동 회피  
- 손실 완만  
- 장기 생존 가능  
- **하루 0회 거래도 정상**

---

## 🏆 최종 요구

이 구조를 기반으로:

1. **단일 ETH 자동매매 시스템**을 구현하라.
2. **PAPER / LIVE 전환**이 가능해야 한다.
3. **관리자 UI**로 제어 가능해야 한다.
4. **상태 JSON**을 제공해야 한다.
5. **안정성과 리스크 관리**를 최우선으로 설계하라.

---

## 📁 기존 코드베이스 참고 (구현 시)

- **A봇**: 추세/트렌드 봇 (Donchian, EMA, DMI/ADX, Adaptive Filter) — `app/worker.py`, `app/services/strategy.py`, `app/backtest.py` 등
- **B봇**: 평균회귀 (BB, RSI, ADX RANGE) — `app/services/bot_b_*.py`, `app/routers/dashboard_b.py`
- **C봇**: 중재봇 (Regime, Strategy 선택, Risk Gate) — `app/services/c_bot*.py`, `app/routers/admin_c_bot.py`
- **웹훅**: TradingView 봉 마감 → `POST /webhook/tv` — `docs/WEBHOOK_TV.md`
- **DB**: MariaDB (events, candles, signals, orders, positions, param_sets, app_settings)

위 스펙에 맞춰 **ETH 단일·보수형·C-A-B·멀티 TF·PAPER/LIVE·관리자 UI**를 통합 구현하라.
